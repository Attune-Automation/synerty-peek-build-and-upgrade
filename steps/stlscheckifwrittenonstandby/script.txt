FOUND=false
TRY=1

echo "postgresqlArchive_timeout = {postgresqlArchive_timeout}"

# Check every 5 seconds.
# Timeout after 10 times postgresqlArchive_timeout.
# Number of checks = 10 x postgresqlArchive_timeout / 5

SLEEP_SECONDS=5
NUMBER_OF_CHECKS=$((10*{postgresqlArchive_timeout}/SLEEP_SECONDS))

let "MAX_MINUTES = ${NUMBER_OF_CHECKS} * ${SLEEP_SECONDS} / 60"
echo "NUMBER_OF_CHECKS=${NUMBER_OF_CHECKS} (${MAX_MINUTES} minutes)."
echo "Checking every ${SLEEP_SECONDS} seconds."

let "EXPECTED_TRIES = {postgresqlArchive_timeout} / ${SLEEP_SECONDS}"
echo "Expect end in check number ${EXPECTED_TRIES} ({postgresqlArchive_timeout} seconds)."

while [ ${FOUND} = false ]
do

    PSQL_OUTPUT=$(psql --dbname="{logShippingTestDatabase}" \
        --command="SELECT * FROM company WHERE
            id=1;") || true

    if echo "${PSQL_OUTPUT}" | grep -q "(1 row)"
    then
        FOUND=true
        echo "Test row written on standby."
    else
        echo "${TRY}. Waiting."
        
        if [ ${TRY} -gt ${NUMBER_OF_CHECKS} ]
        then
            echo "timed out"
            exit 1
        fi
        
        ((TRY=TRY+1))
        sleep ${SLEEP_SECONDS}   
    fi
done